# Deep-AutoQC
Image classification for the ENIGMA HALFpipe project at Charité  using deep learning - Bachelor Thesis
DeepAutoQC aims to assist researchers in classifying skull strip reports as either usable (good) or unusable (bad).

# Introduction

Welcome to this project. It started out as the basis for a bachelor's thesis and has since then been continuously evolving. The original, stable version used for the thesis can be found in the `archive` branch.

The current focus is to improve the existing work. We're in the process of transitioning the code to use the PyTorch Lightning framework. Please note that this project is currently a work in progress.

## Folder Structure
````
├── README.md                   <- Provides an overview of the project.
├── mypy.ini                    <- Configuration file for MyPy, a static type checker for Python.
├── pyproject.toml              <- Contains metadata about the project; used to manage project dependencies and versions.
├── requirements.txt            <- Lists the Python dependencies required to run the project.
└── src                         <- Source directory containing the project's code.
    └── deepautoqc              <- Main package containing the project's modules, scripts, and related files.
        ├── __init__.py         <- Required for Python to treat this directory as containing packages.
        ├── __pycache__         <- Contains Python's compiled bytecode files.
        ├── data                <- Directory for data related files.
        ├── data_structures.py  <- Defines data structures used throughout the project.
        ├── lightning_logs      <- Contains log files generated by PyTorch Lightning.
        ├── lightning_module.py <- Defines the PyTorch Lightning module for the project and currently the training pipeline.
        ├── models.py           <- Contains neural network models definitions for Transfusion model and ResNet.
        ├── svg_parser_usable.py <- Used for parsing SVG files of skull-strip_reports.
        ├── utils.py            <- Contains utility functions used across the project.
        └── visualization.ipynb <- Jupyter notebook used for data visualization and analysis.
````

# Training Process

This script is designed for training the MRI Quality Control (MRIAutoQC) model on brain scan data. The main parts of this process are argument parsing, data preparation, model training, and testing.

## Argument Parsing

The script accepts several arguments that allow you to customize the training process:

- `-dl` or `--data_location`: Choose between `local` and `cluster` to determine the data paths. This determines whether the script uses data stored locally or on a cluster.
- `-mn` or `--model_name`: Selects the architecture of the Transfusion model used for training. Options include `small`, `tiny`, `wide`, and `tall`.
- `-e` or `--epochs`: The number of epochs to train the network. The default is 20.

## Data Preparation

The data for the model is prepared using the `BrainScanDataModule`. This PyTorch Lightning DataModule is responsible for loading the brain scan data from either a local path or a cluster, and preparing it for training.

## Model Training

The `MRIAutoQC` model is trained using the PyTorch Lightning Trainer. The trainer is set up with several options:

- `accelerator="auto"`: Automatically selects the appropriate hardware accelerator (CPU, GPU, or TPU) available on the machine.
- `deterministic="warn"`: If any operations are performed that could cause non-deterministic behavior, a warning will be raised.
- `enable_progress_bar=True`: Enables a progress bar to be displayed during training.
- `max_epochs=args.epochs`: Sets the maximum number of epochs for training.

The trainer is then used to fit the model on the training and validation data, which are obtained from the DataModule.

## Testing

After training, the model is tested on the test data, which is again obtained from the DataModule.

## Running the Script

To run the script, you can use a command similar to the following:

```
python train.py --data_location local --model_name small --epochs 30
```

This command would train the `small` model on `local` data for `30` epochs. Adjust the arguments as needed for your specific use case.

~~## Resume Training~~
~~You can resume training from a previously saved checkpoint by:~~
~~`python train.py -r ckpt/path`~~

~~## For Predictions~~
~~* check the `ckpts/` folder and set `MODEL_CKPT` to your desired `*model.pt` which will be loaded for predictions~~

~~Then, run `python3 test.py [-h] -i INPUT`. Remember `the following arguments are required: -i/--input` should contain the path to your svg file.~~
~~Check `predictions` folder for your output.~~

~~## Weights~~
~~* Weights of every trained model are stored in `/src/deepautoqc/weights` with their respective names and the dataset on which they got trained on~~
